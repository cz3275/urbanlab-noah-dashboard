import folium
from folium import plugins
import pandas as pd
import json
from utils.zip_coords import NYC_ZIP_COORDS, NYC_CENTER

# Legacy compatibility - coordinates now imported from zip_coords module

_NYC_ZIP_COORDS_LEGACY = {
    "10001": [40.7506, -73.9971], "10002": [40.7156, -73.9866], "10003": [40.7314, -73.9883],
    "10004": [40.7035, -74.0139], "10005": [40.7060, -74.0088], "10006": [40.7090, -74.0126],
    "10007": [40.7133, -74.0070], "10009": [40.7265, -73.9782], "10010": [40.7390, -73.9810],
    "10011": [40.7406, -73.9989], "10012": [40.7255, -73.9983], "10013": [40.7199, -74.0032],
    "10014": [40.7340, -74.0063], "10016": [40.7459, -73.9765], "10017": [40.7520, -73.9724],
    "10018": [40.7550, -73.9924], "10019": [40.7664, -73.9866], "10021": [40.7688, -73.9595],
    "10022": [40.7578, -73.9668], "10023": [40.7765, -73.9820], "10024": [40.7917, -73.9739],
    "10025": [40.7983, -73.9666], "10026": [40.8022, -73.9524], "10027": [40.8116, -73.9533],
    "10028": [40.7765, -73.9533], "10029": [40.7918, -73.9437], "10030": [40.8186, -73.9428],
    "10031": [40.8256, -73.9497], "10032": [40.8388, -73.9426], "10033": [40.8502, -73.9346],
    "10034": [40.8671, -73.9218], "10035": [40.7957, -73.9294], "10036": [40.7590, -73.9898],
    "10037": [40.8128, -73.9372], "10038": [40.7088, -74.0023], "10039": [40.8268, -73.9363],
    "10040": [40.8584, -73.9301], "10044": [40.7614, -73.9501], "10065": [40.7644, -73.9635],
    "10069": [40.7766, -73.9910], "10075": [40.7719, -73.9565], "10128": [40.7815, -73.9502],
    "10280": [40.7152, -74.0166], "10282": [40.7168, -74.0145],
    "10301": [40.6330, -74.0935], "10302": [40.6293, -74.1348], "10303": [40.6321, -74.1663],
    "10304": [40.6098, -74.0947], "10305": [40.5992, -74.0752], "10306": [40.5700, -74.1222],
    "10307": [40.5069, -74.2425], "10308": [40.5545, -74.1515], "10309": [40.5320, -74.2212],
    "10310": [40.6310, -74.1155], "10312": [40.5450, -74.1780], "10314": [40.5975, -74.1654],
    "10451": [40.8211, -73.9253], "10452": [40.8380, -73.9188], "10453": [40.8520, -73.9116],
    "10454": [40.8057, -73.9181], "10455": [40.8156, -73.9069], "10456": [40.8294, -73.9099],
    "10457": [40.8475, -73.9001], "10458": [40.8620, -73.8878], "10459": [40.8258, -73.8941],
    "10460": [40.8418, -73.8795], "10461": [40.8484, -73.8418], "10462": [40.8404, -73.8608],
    "10463": [40.8793, -73.9074], "10464": [40.8665, -73.7955], "10465": [40.8268, -73.8220],
    "10466": [40.8899, -73.8469], "10467": [40.8732, -73.8715], "10468": [40.8680, -73.9000],
    "10469": [40.8687, -73.8463], "10470": [40.8896, -73.8672], "10471": [40.8991, -73.9014],
    "10472": [40.8294, -73.8736], "10473": [40.8195, -73.8581], "10474": [40.8107, -73.8875],
    "10475": [40.8781, -73.8250],
    "11004": [40.7450, -73.7124], "11101": [40.7450, -73.9383], "11102": [40.7706, -73.9260],
    "11103": [40.7625, -73.9118], "11104": [40.7447, -73.9198], "11105": [40.7789, -73.9062],
    "11106": [40.7625, -73.9319], "11109": [40.7438, -73.9576], "11201": [40.6938, -73.9900],
    "11203": [40.6497, -73.9341], "11204": [40.6185, -73.9844], "11205": [40.6953, -73.9661],
    "11206": [40.7016, -73.9426], "11207": [40.6706, -73.8939], "11208": [40.6699, -73.8711],
    "11209": [40.6217, -74.0303], "11210": [40.6281, -73.9463], "11211": [40.7127, -73.9540],
    "11212": [40.6629, -73.9137], "11213": [40.6710, -73.9360], "11214": [40.5993, -73.9963],
    "11215": [40.6628, -73.9865], "11216": [40.6806, -73.9495], "11217": [40.6821, -73.9795],
    "11218": [40.6438, -73.9763], "11219": [40.6321, -73.9963], "11220": [40.6408, -74.0168],
    "11221": [40.6911, -73.9275], "11222": [40.7264, -73.9476], "11223": [40.5973, -73.9735],
    "11224": [40.5771, -73.9885], "11225": [40.6632, -73.9548], "11226": [40.6463, -73.9562],
    "11228": [40.6163, -74.0135], "11229": [40.6000, -73.9447], "11230": [40.6223, -73.9658],
    "11231": [40.6776, -74.0059], "11232": [40.6565, -74.0096], "11233": [40.6788, -73.9201],
    "11234": [40.6034, -73.9096], "11235": [40.5845, -73.9495], "11236": [40.6401, -73.9007],
    "11237": [40.7044, -73.9209], "11238": [40.6794, -73.9641], "11239": [40.6472, -73.8794],
    "11354": [40.7686, -73.8264], "11355": [40.7528, -73.8201], "11356": [40.7852, -73.8421],
    "11357": [40.7864, -73.8122], "11358": [40.7603, -73.7986], "11360": [40.7820, -73.7795],
    "11361": [40.7642, -73.7736], "11362": [40.7572, -73.7361], "11363": [40.7724, -73.7449],
    "11364": [40.7451, -73.7620], "11365": [40.7395, -73.7944], "11366": [40.7283, -73.7943],
    "11367": [40.7291, -73.8233], "11368": [40.7510, -73.8554], "11369": [40.7630, -73.8720],
    "11370": [40.7644, -73.8900], "11372": [40.7514, -73.8836], "11373": [40.7387, -73.8779],
    "11374": [40.7262, -73.8614], "11375": [40.7208, -73.8458], "11377": [40.7443, -73.9052],
    "11378": [40.7244, -73.9095], "11379": [40.7162, -73.8797], "11385": [40.7004, -73.8882],
    "11411": [40.6924, -73.7367], "11412": [40.6981, -73.7603], "11413": [40.6710, -73.7526],
    "11414": [40.6581, -73.8441], "11415": [40.7076, -73.8276], "11416": [40.6850, -73.8514],
    "11417": [40.6779, -73.8441], "11418": [40.7006, -73.8300], "11419": [40.6886, -73.8217],
    "11420": [40.6726, -73.8219], "11421": [40.6943, -73.8589], "11422": [40.6600, -73.7360],
    "11423": [40.7164, -73.7679], "11426": [40.7365, -73.7234], "11427": [40.7291, -73.7447],
    "11428": [40.7218, -73.7423], "11429": [40.7096, -73.7445], "11432": [40.7149, -73.7937],
    "11433": [40.6985, -73.7876], "11434": [40.6755, -73.7760], "11435": [40.7017, -73.8095],
    "11436": [40.6762, -73.7983], "11691": [40.6011, -73.7557], "11692": [40.5936, -73.7902],
    "11693": [40.5930, -73.8049], "11694": [40.5775, -73.8428], "11697": [40.5588, -73.9166]
}

def create_map(data: pd.DataFrame, metric_column: str, color_scheme: str = "YlOrRd", map_style: str = "CartoDB positron") -> folium.Map:
    nyc_map = folium.Map(
        location=NYC_CENTER,
        zoom_start=10,
        tiles=map_style
    )
    
    if data is not None and not data.empty and metric_column in data.columns:
        valid_data = data[data["zip"].notna()].copy()
        
        for _, row in valid_data.iterrows():
            zip_code = str(row["zip"]).zfill(5)
            
            if zip_code in NYC_ZIP_COORDS:
                coords = NYC_ZIP_COORDS[zip_code]
                metric_value = row.get(metric_column)
                
                if pd.notna(metric_value):
                    median_rent = pd.to_numeric(row.get('median_rent'), errors='coerce')
                    median_income = pd.to_numeric(row.get('median_income'), errors='coerce')
                    vacancy_rate = pd.to_numeric(row.get('vacancy_rate'), errors='coerce')
                    housing_units = pd.to_numeric(row.get('housing_units'), errors='coerce')
                    
                    rent_str = f"${median_rent:,.0f}" if pd.notna(median_rent) else "N/A"
                    income_str = f"${median_income:,.0f}" if pd.notna(median_income) else "N/A"
                    vacancy_str = f"{vacancy_rate*100:.1f}%" if pd.notna(vacancy_rate) else "N/A"
                    units_str = f"{housing_units:,.0f}" if pd.notna(housing_units) else "N/A"
                    
                    popup_text = f"""
                    <div style="font-family: Arial; font-size: 12px;">
                        <b>ZIP: {zip_code}</b><br>
                        <b>Median Rent:</b> {rent_str}<br>
                        <b>Median Income:</b> {income_str}<br>
                        <b>Vacancy Rate:</b> {vacancy_str}<br>
                        <b>Housing Units:</b> {units_str}
                    </div>
                    """
                    
                    if metric_column == "median_rent":
                        color = get_color_by_value(metric_value, 0, 3500, color_scheme)
                    elif metric_column == "median_income":
                        color = get_color_by_value(metric_value, 0, 150000, color_scheme)
                    elif metric_column == "vacancy_rate":
                        color = get_color_by_value(metric_value, 0, 0.5, color_scheme)
                    elif metric_column == "housing_units":
                        color = get_color_by_value(metric_value, 0, 50000, color_scheme)
                    else:
                        color = "blue"
                    
                    folium.CircleMarker(
                        location=coords,
                        radius=8,
                        popup=folium.Popup(popup_text, max_width=300),
                        tooltip=f"ZIP: {zip_code}",
                        color=color,
                        fill=True,
                        fillColor=color,
                        fillOpacity=0.7,
                        weight=2
                    ).add_to(nyc_map)
    
    return nyc_map

def get_color_by_value(value, min_val, max_val, scheme="YlOrRd"):
    if pd.isna(value) or value is None:
        return "gray"
    
    try:
        value = float(value)
    except (ValueError, TypeError):
        return "gray"
    
    normalized = (value - min_val) / (max_val - min_val) if max_val > min_val else 0
    normalized = max(0, min(1, normalized))
    
    color_maps = {
        "YlOrRd": ["#ffffb2", "#fecc5c", "#fd8d3c", "#f03b20", "#bd0026"],
        "Blues": ["#eff3ff", "#bdd7e7", "#6baed6", "#3182bd", "#08519c"],
        "Greens": ["#edf8e9", "#bae4b3", "#74c476", "#31a354", "#006d2c"]
    }
    
    colors = color_maps.get(scheme, color_maps["YlOrRd"])
    idx = int(normalized * (len(colors) - 1))
    return colors[idx]
